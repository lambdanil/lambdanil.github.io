---
layout: post
title: Diving into the Guix internals
permalink: /:title/
tags: [guix, scheme]
---
<p>
One of the great things about Guix is that it uses Scheme (Guile specifically) as its implementation language.
Due to the functional design of the system this decision actually impacts not only developers, but also users of Guix and Guix System, so the language choice is a lot more important here than in other projects.
What's great about Scheme is that it's an established language with an existing ecosystem and tooling. What's more than that, is that it also has a very functional REPL, which can be integrated with Emacs using Geiser.
The usability of this tooling extends all the way to almost all parts of the Guix source - this means I can take it apart piece by piece using the existing tools, which is very convenient.
This realization is actually where my idea to "dive in" with a REPL was born.
</p>

<p>
Let's spin up Emacs and get hacking!
</p>

<div id="outline-container-org37a4733" class="outline-2">
<h2 id="org37a4733">The setup</h2>
<div class="outline-text-2" id="text-org37a4733">
<p>
So of course before any hacking begins I'll have to prepare my Emacs environment for the task. There's a few steps I need to take, though all of them pretty straightforward.
</p>

<p>
Most of the steps here are taken right from the Guix manual, see <a href="https://guix.gnu.org/en/manual/en/guix.html#The-Perfect-Setup">https://guix.gnu.org/en/manual/en/guix.html#The-Perfect-Setup</a>.
</p>

<p>
I'll first need to set up all the necessary dependencies - fortunately Guix makes this very straightforward.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #bd93f9; font-weight: bold;">guix</span> install guix guile
</pre>
</div>

<p>
Next I'll need the actual Guix development repositories cloned locally, this is a quick process too.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ffb86c; font-weight: bold;">cd</span> <span style="color: #ff79c6;">$</span><span style="color: #8be9fd; font-style: italic;">HOME</span>
<span style="color: #bd93f9; font-weight: bold;">git</span> clone https://git.savannah.gnu.org/git/guix.git
</pre>
</div>

<p>
Finally I could set up Geiser inside Emacs. Here I use the path I cloned the repository to, <code>$HOME/guix</code> in my case.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #61bfff;">(</span><span style="color: #ff79c6;">with-eval-after-load</span> 'geiser-guile
  <span style="color: #ff79c6;">(</span>add-to-list 'geiser-guile-load-path <span style="color: #f1fa8c;">"~/guix"</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
</pre>
</div>

<p>
I'll also compile all the Guix files now, so I can work in the REPL uninterrupted by compiles. I can use <code>guix shell</code> to ensure I have the fully correct development environment.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ffb86c; font-weight: bold;">cd</span> ~/guix
<span style="color: #bd93f9; font-weight: bold;">guix</span> shell <span style="color: #8be9fd;">-D</span> guix <span style="color: #8be9fd;">--pure</span>
<span style="color: #bd93f9; font-weight: bold;">./bootstrap</span>
<span style="color: #bd93f9; font-weight: bold;">make</span> clean
<span style="color: #bd93f9; font-weight: bold;">make</span> <span style="color: #8be9fd;">-j10</span>
<span style="color: #bd93f9; font-weight: bold;">exit</span> <span style="color: #6272a4;"># leave the Guix shell</span>
</pre>
</div>
<p>
This takes a while but finishes successfully eventually.
</p>

<p>
I also have a couple of my own little modules for Guix as well as nonguix, but since I won't be diving into these I won't bother cloning them now.
</p>
</div>
</div>

<div id="outline-container-org26d0406" class="outline-2">
<h2 id="org26d0406">The starting point</h2>
<div class="outline-text-2" id="text-org26d0406">
<p>
So where exactly does one start hacking on such a complex project? Well I decided to start with the part I was already most familiar with - the Guix System configuration. Here's my current configuration for reference (yes, it's a little lengthy!).
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span>add-to-load-path <span style="color: #f1fa8c;">"/etc/guix-modules"</span><span style="color: #61bfff;">)</span>

<span style="color: #61bfff;">(</span><span style="color: #ff79c6;">use-modules</span> <span style="color: #ff79c6;">(</span>gnu<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services dbus<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu packages gnome<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>nongnu packages linux<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>nongnu system linux-initrd<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services virtualization<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services shepherd<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services admin<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>guix channels<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services mcron<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services docker<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>nil services mount-rshared<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>nil packages gnome<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu packages fonts<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu packages networking<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>guix gexp<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>guix packages<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>srfi srfi-1<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
<span style="color: #61bfff;">(</span>use-service-modules linux desktop networking ssh xorg<span style="color: #61bfff;">)</span>
<span style="color: #61bfff;">(</span>use-package-modules linux package-management<span style="color: #61bfff;">)</span>

<span style="color: #61bfff;">(</span><span style="color: #ff79c6;">define</span> <span style="color: #50fa7b;">%my-services</span>
  <span style="color: #ff79c6;">(</span>modify-services %desktop-services
                   <span style="color: #50fa7b;">(</span>delete gdm-service-type<span style="color: #50fa7b;">)</span>
                   <span style="color: #50fa7b;">(</span>guix-service-type config =&gt; <span style="color: #bd93f9;">(</span>guix-configuration
                                                 <span style="color: #0189cc;">(</span>inherit config<span style="color: #0189cc;">)</span>
                                                 <span style="color: #0189cc;">(</span>substitute-urls
                                                  <span style="color: #61bfff;">(</span>append <span style="color: #ff79c6;">(</span>list <span style="color: #f1fa8c;">"https://substitutes.nonguix.org"</span><span style="color: #ff79c6;">)</span>
                                                          %default-substitute-urls<span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>
                                                 <span style="color: #0189cc;">(</span>authorized-keys
                                                  <span style="color: #61bfff;">(</span>append <span style="color: #ff79c6;">(</span>list <span style="color: #50fa7b;">(</span>local-file <span style="color: #f1fa8c;">"./signing-key.pub"</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
                                                          %default-authorized-guix-keys<span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
                   <span style="color: #50fa7b;">(</span>dbus-root-service-type config =&gt;
                                           <span style="color: #bd93f9;">(</span>dbus-configuration <span style="color: #0189cc;">(</span>inherit config<span style="color: #0189cc;">)</span>
                                                               <span style="color: #0189cc;">(</span>services <span style="color: #61bfff;">(</span>list libratbag blueman<span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>

<span style="color: #61bfff;">(</span>operating-system

 <span style="color: #ff79c6;">(</span>locale <span style="color: #f1fa8c;">"cs_CZ.utf8"</span><span style="color: #ff79c6;">)</span>
 <span style="color: #ff79c6;">(</span>timezone <span style="color: #f1fa8c;">"Europe/Prague"</span><span style="color: #ff79c6;">)</span>
 <span style="color: #ff79c6;">(</span>keyboard-layout <span style="color: #50fa7b;">(</span>keyboard-layout <span style="color: #f1fa8c;">"cz"</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

 <span style="color: #ff79c6;">(</span>host-name <span style="color: #f1fa8c;">"eternity"</span><span style="color: #ff79c6;">)</span>

 <span style="color: #ff79c6;">(</span>kernel linux<span style="color: #ff79c6;">)</span>
 <span style="color: #ff79c6;">(</span>initrd microcode-initrd<span style="color: #ff79c6;">)</span>
 <span style="color: #ff79c6;">(</span>firmware <span style="color: #50fa7b;">(</span>list linux-firmware<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

 <span style="color: #ff79c6;">(</span>groups 
  <span style="color: #50fa7b;">(</span>cons* 
   <span style="color: #bd93f9;">(</span>user-group <span style="color: #0189cc;">(</span>name <span style="color: #f1fa8c;">"games"</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span> <span style="color: #6272a4;">;; </span><span style="color: #6272a4;">For libratbagd</span>
   <span style="color: #bd93f9;">(</span>user-group <span style="color: #0189cc;">(</span>name <span style="color: #f1fa8c;">"realtime"</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span>
   %base-groups<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

 <span style="color: #ff79c6;">(</span>users <span style="color: #50fa7b;">(</span>cons* <span style="color: #bd93f9;">(</span>user-account
                <span style="color: #0189cc;">(</span>name <span style="color: #f1fa8c;">"nil"</span><span style="color: #0189cc;">)</span>
                <span style="color: #0189cc;">(</span>comment <span style="color: #f1fa8c;">"(lambda () nil)"</span><span style="color: #0189cc;">)</span>
                <span style="color: #0189cc;">(</span>group <span style="color: #f1fa8c;">"users"</span><span style="color: #0189cc;">)</span>
                <span style="color: #0189cc;">(</span>home-directory <span style="color: #f1fa8c;">"/home/nil"</span><span style="color: #0189cc;">)</span>
                <span style="color: #0189cc;">(</span>supplementary-groups
                 '<span style="color: #61bfff;">(</span><span style="color: #f1fa8c;">"wheel"</span> <span style="color: #f1fa8c;">"netdev"</span> <span style="color: #f1fa8c;">"audio"</span> <span style="color: #f1fa8c;">"video"</span> <span style="color: #f1fa8c;">"lp"</span> <span style="color: #f1fa8c;">"libvirt"</span> <span style="color: #f1fa8c;">"kvm"</span> <span style="color: #f1fa8c;">"games"</span> <span style="color: #f1fa8c;">"docker"</span> <span style="color: #f1fa8c;">"realtime"</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span>
               %base-user-accounts<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

 <span style="color: #ff79c6;">(</span>packages
  <span style="color: #50fa7b;">(</span>append
   <span style="color: #bd93f9;">(</span><span style="color: #ff79c6;">map</span> specification-&gt;package
        <span style="color: #0189cc;">(</span>list
         <span style="color: #f1fa8c;">"nss-certs"</span>
         <span style="color: #f1fa8c;">"xf86-video-amdgpu"</span>
         <span style="color: #f1fa8c;">"amdgpu-firmware"</span>
         <span style="color: #f1fa8c;">"bluez"</span>
         <span style="color: #f1fa8c;">"blueman"</span>
         <span style="color: #f1fa8c;">"vim"</span>
         <span style="color: #f1fa8c;">"sway"</span>
         <span style="color: #f1fa8c;">"wofi"</span>
         <span style="color: #f1fa8c;">"libratbag"</span>
         <span style="color: #f1fa8c;">"git"</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span>
   %base-packages<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

 <span style="color: #ff79c6;">(</span>services
  <span style="color: #50fa7b;">(</span>append
   <span style="color: #bd93f9;">(</span>list
    <span style="color: #0189cc;">(</span>service gdm-service-type
             <span style="color: #61bfff;">(</span>gdm-configuration
              <span style="color: #ff79c6;">(</span>wayland? #t<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>
    <span style="color: #0189cc;">(</span>service bluetooth-service-type
             <span style="color: #61bfff;">(</span>bluetooth-configuration
              <span style="color: #ff79c6;">(</span>auto-enable? #f<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>

    mount-rshared-service

    <span style="color: #0189cc;">(</span>pam-limits-service
     <span style="color: #61bfff;">(</span>list <span style="color: #ff79c6;">(</span>pam-limits-entry <span style="color: #f1fa8c;">"*"</span> 'hard 'nofile 524288<span style="color: #ff79c6;">)</span>
           <span style="color: #ff79c6;">(</span>pam-limits-entry <span style="color: #f1fa8c;">"@realtime"</span> 'both 'rtprio 99<span style="color: #ff79c6;">)</span>
           <span style="color: #ff79c6;">(</span>pam-limits-entry <span style="color: #f1fa8c;">"@realtime"</span> 'both 'memlock 'unlimited<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>

    <span style="color: #0189cc;">(</span>extra-special-file <span style="color: #f1fa8c;">"/lib64/ld-linux-x86-64.so.2"</span>
                        <span style="color: #61bfff;">(</span>file-append glibc <span style="color: #f1fa8c;">"/lib/ld-linux-x86-64.so.2"</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>

    <span style="color: #0189cc;">(</span>set-xorg-configuration
     <span style="color: #61bfff;">(</span>xorg-configuration
      <span style="color: #ff79c6;">(</span>keyboard-layout keyboard-layout<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>

    <span style="color: #0189cc;">(</span>service virtlog-service-type
             <span style="color: #61bfff;">(</span>virtlog-configuration
              <span style="color: #ff79c6;">(</span>max-clients 1000<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>

    <span style="color: #0189cc;">(</span>service libvirt-service-type
             <span style="color: #61bfff;">(</span>libvirt-configuration
              <span style="color: #ff79c6;">(</span>unix-sock-group <span style="color: #f1fa8c;">"libvirt"</span><span style="color: #ff79c6;">)</span>
              <span style="color: #ff79c6;">(</span>tls-port <span style="color: #f1fa8c;">"16555"</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>

    <span style="color: #0189cc;">(</span>service docker-service-type<span style="color: #0189cc;">)</span>

    <span style="color: #0189cc;">(</span>service zram-device-service-type
             <span style="color: #61bfff;">(</span>zram-device-configuration
              <span style="color: #ff79c6;">(</span>size <span style="color: #f1fa8c;">"8172M"</span><span style="color: #ff79c6;">)</span>
              <span style="color: #ff79c6;">(</span>compression-algorithm 'zstd<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span>
   %my-services<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

 <span style="color: #ff79c6;">(</span>bootloader
  <span style="color: #50fa7b;">(</span>bootloader-configuration
   <span style="color: #bd93f9;">(</span>bootloader grub-efi-bootloader<span style="color: #bd93f9;">)</span>
   <span style="color: #bd93f9;">(</span>targets '<span style="color: #0189cc;">(</span><span style="color: #f1fa8c;">"/boot/efi"</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span>
   <span style="color: #bd93f9;">(</span>timeout 3<span style="color: #bd93f9;">)</span>
   <span style="color: #bd93f9;">(</span>keyboard-layout keyboard-layout<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
 <span style="color: #ff79c6;">(</span>file-systems
  <span style="color: #50fa7b;">(</span>cons*   
   <span style="color: #bd93f9;">(</span>file-system
    <span style="color: #0189cc;">(</span>mount-point <span style="color: #f1fa8c;">"/"</span><span style="color: #0189cc;">)</span>
    <span style="color: #0189cc;">(</span>device
     <span style="color: #61bfff;">(</span>uuid <span style="color: #f1fa8c;">""</span>
           'btrfs<span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>
    <span style="color: #0189cc;">(</span>type <span style="color: #f1fa8c;">"btrfs"</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span>
   <span style="color: #bd93f9;">(</span>file-system
    <span style="color: #0189cc;">(</span>mount-point <span style="color: #f1fa8c;">"/boot/efi"</span><span style="color: #0189cc;">)</span>
    <span style="color: #0189cc;">(</span>device
     <span style="color: #61bfff;">(</span>uuid <span style="color: #f1fa8c;">""</span>
           'fat32<span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>
    <span style="color: #0189cc;">(</span>type <span style="color: #f1fa8c;">"vfat"</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span>
   <span style="color: #bd93f9;">(</span>file-system <span style="color: #6272a4;">;; </span><span style="color: #6272a4;">Second hard drive</span>
    <span style="color: #0189cc;">(</span>mount-point <span style="color: #f1fa8c;">"/mnt/media/nil/external"</span><span style="color: #0189cc;">)</span>
    <span style="color: #0189cc;">(</span>device
     <span style="color: #61bfff;">(</span>uuid <span style="color: #f1fa8c;">""</span>
           'ext4<span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>
    <span style="color: #0189cc;">(</span>type <span style="color: #f1fa8c;">"ext4"</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span>
   %base-file-systems<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
</pre>
</div>

<p>
I start up a Geiser REPL and begin by importing all my modules, basically just copy-pasting from the header of this file. I had to remove a few modules that I didn't have definitions locally available for.
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span><span style="color: #ff79c6;">use-modules</span> <span style="color: #ff79c6;">(</span>gnu<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services dbus<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu packages gnome<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services virtualization<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services shepherd<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services admin<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>guix channels<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services mcron<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu services docker<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu packages fonts<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>gnu packages networking<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>guix gexp<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>guix packages<span style="color: #ff79c6;">)</span>
             <span style="color: #ff79c6;">(</span>srfi srfi-1<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
<span style="color: #61bfff;">(</span>use-service-modules linux desktop networking ssh xorg<span style="color: #61bfff;">)</span>
<span style="color: #61bfff;">(</span>use-package-modules linux package-management<span style="color: #61bfff;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb6e9c6c" class="outline-2">
<h2 id="orgb6e9c6c">The hacking begins - the operating system record</h2>
<div class="outline-text-2" id="text-orgb6e9c6c">
<p>
I think the best place to begin is the actual <code>operating-system</code> declaration. Using <code>xref-find-definitions</code> (bound to <code>M-.</code> by default)  I can jump straight to where it's defined. Here's what the definition looks like (be warned, another lengthy definition below!):
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span>define-record-type* <span style="color: #bd93f9;">&lt;operating-system&gt;</span> operating-system
  make-operating-system
  operating-system?
  this-operating-system

  <span style="color: #ff79c6;">(</span>kernel operating-system-kernel                 <span style="color: #6272a4;">; </span><span style="color: #6272a4;">package</span>
          <span style="color: #50fa7b;">(</span>default linux-libre<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>kernel-loadable-modules operating-system-kernel-loadable-modules
                           <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>                <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of packages</span>
  <span style="color: #ff79c6;">(</span>kernel-arguments operating-system-user-kernel-arguments
                    <span style="color: #50fa7b;">(</span>default %default-kernel-arguments<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span> <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of gexps/strings</span>
  <span style="color: #ff79c6;">(</span>hurd operating-system-hurd
        <span style="color: #50fa7b;">(</span>default #f<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>                             <span style="color: #6272a4;">; </span><span style="color: #6272a4;">package</span>
  <span style="color: #ff79c6;">(</span>bootloader operating-system-bootloader<span style="color: #ff79c6;">)</span>        <span style="color: #6272a4;">; </span><span style="color: #6272a4;">&lt;bootloader-configuration&gt;</span>
  <span style="color: #ff79c6;">(</span>label operating-system-label                   <span style="color: #6272a4;">; </span><span style="color: #6272a4;">string</span>
         <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span>
         <span style="color: #50fa7b;">(</span>default <span style="color: #bd93f9;">(</span>operating-system-default-label this-operating-system<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>keyboard-layout operating-system-keyboard-layout <span style="color: #6272a4;">;</span><span style="color: #6272a4;">#f | &lt;keyboard-layout&gt;</span>
                   <span style="color: #50fa7b;">(</span>default #f<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>initrd operating-system-initrd                 <span style="color: #6272a4;">; </span><span style="color: #6272a4;">(list fs) -&gt; file-like</span>
          <span style="color: #50fa7b;">(</span>default base-initrd<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>initrd-modules operating-system-initrd-modules <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of strings</span>
                  <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span>                       <span style="color: #6272a4;">; </span><span style="color: #6272a4;">it's system-dependent</span>
                  <span style="color: #50fa7b;">(</span>default %base-initrd-modules<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>firmware operating-system-firmware             <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of packages</span>
            <span style="color: #50fa7b;">(</span>default %base-firmware<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>host-name operating-system-host-name<span style="color: #ff79c6;">)</span>          <span style="color: #6272a4;">; </span><span style="color: #6272a4;">string</span>
  <span style="color: #ff79c6;">(</span>hosts-file %operating-system-hosts-file         <span style="color: #6272a4;">; </span><span style="color: #6272a4;">deprecated</span>
              <span style="color: #50fa7b;">(</span>default #f<span style="color: #50fa7b;">)</span>
              <span style="color: #50fa7b;">(</span>sanitize warn-hosts-file-field-deprecation<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>mapped-devices operating-system-mapped-devices <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of &lt;mapped-device&gt;</span>
                  <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>file-systems operating-system-file-systems<span style="color: #ff79c6;">)</span>    <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of fs</span>
  <span style="color: #ff79c6;">(</span>swap-devices operating-system-swap-devices     <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of string | &lt;swap-space&gt;</span>
                <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span>
                <span style="color: #50fa7b;">(</span>delayed<span style="color: #50fa7b;">)</span>
                <span style="color: #50fa7b;">(</span>sanitize warn-swap-devices-change<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>users operating-system-users                   <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of user accounts</span>
         <span style="color: #50fa7b;">(</span>default %base-user-accounts<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>groups operating-system-groups                 <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of user groups</span>
          <span style="color: #50fa7b;">(</span>default %base-groups<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>skeletons operating-system-skeletons           <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of name/file-like value</span>
             <span style="color: #50fa7b;">(</span>default <span style="color: #bd93f9;">(</span>default-skeletons<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>issue operating-system-issue                   <span style="color: #6272a4;">; </span><span style="color: #6272a4;">string</span>
         <span style="color: #50fa7b;">(</span>default %default-issue<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>packages operating-system-packages             <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of (PACKAGE OUTPUT...)</span>
            <span style="color: #50fa7b;">(</span>default %base-packages<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>             <span style="color: #6272a4;">; </span><span style="color: #6272a4;">or just PACKAGE</span>

  <span style="color: #ff79c6;">(</span>timezone operating-system-timezone
            <span style="color: #50fa7b;">(</span>default <span style="color: #f1fa8c;">"Etc/UTC"</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>                  <span style="color: #6272a4;">; </span><span style="color: #6272a4;">string</span>
  <span style="color: #ff79c6;">(</span>locale   operating-system-locale               <span style="color: #6272a4;">; </span><span style="color: #6272a4;">string</span>
            <span style="color: #50fa7b;">(</span>default <span style="color: #f1fa8c;">"en_US.utf8"</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>locale-definitions operating-system-locale-definitions <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of &lt;locale-definition&gt;</span>
                      <span style="color: #50fa7b;">(</span>default %default-locale-definitions<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>locale-libcs operating-system-locale-libcs     <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of &lt;packages&gt;</span>
                <span style="color: #50fa7b;">(</span>default %default-locale-libcs<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>name-service-switch operating-system-name-service-switch <span style="color: #6272a4;">; </span><span style="color: #6272a4;">&lt;name-service-switch&gt;</span>
                       <span style="color: #50fa7b;">(</span>default %default-nss<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>essential-services operating-system-essential-services <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of services</span>
                      <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span>
                      <span style="color: #50fa7b;">(</span>default <span style="color: #bd93f9;">(</span>operating-system-default-essential-services
                                this-operating-system<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>services operating-system-user-services        <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of services</span>
            <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span>                     <span style="color: #6272a4;">;</span><span style="color: #6272a4;">allow for system-dependent services</span>
            <span style="color: #50fa7b;">(</span>default %base-services<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>pam-services operating-system-pam-services     <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of PAM services</span>
                <span style="color: #50fa7b;">(</span>default <span style="color: #bd93f9;">(</span>base-pam-services<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>setuid-programs operating-system-setuid-programs
                   <span style="color: #50fa7b;">(</span>default %setuid-programs<span style="color: #50fa7b;">)</span>     <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of &lt;setuid-program&gt;</span>
                   <span style="color: #50fa7b;">(</span>sanitize ensure-setuid-program-list<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>sudoers-file operating-system-sudoers-file     <span style="color: #6272a4;">; </span><span style="color: #6272a4;">file-like</span>
                <span style="color: #50fa7b;">(</span>default %sudoers-specification<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>location operating-system-location             <span style="color: #6272a4;">; </span><span style="color: #6272a4;">&lt;location&gt;</span>
            <span style="color: #50fa7b;">(</span>default <span style="color: #bd93f9;">(</span>and=&gt; <span style="color: #0189cc;">(</span>current-source-location<span style="color: #0189cc;">)</span>
                            source-properties-&gt;location<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
            <span style="color: #50fa7b;">(</span>innate<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
</pre>
</div>
<p>
I can immediately spot some familiar pieces here.
</p>

<p>
So <code>operating-system</code> is actually a <b>Scheme record</b>. These are used very often in the Guix source code, and we'll see them a lot.
A record is a fairly straightforward kind of object, one consisting of 2 parts - the keys and their values. Each key has a single value assigned to it.
</p>

<p>
One of the very first keys here looks like this:
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span>kernel-arguments operating-system-user-kernel-arguments
                  <span style="color: #ff79c6;">(</span>default %default-kernel-arguments<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span> <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of gexps/strings</span>
</pre>
</div>

<p>
Even without great understanding of the record syntax it's clear what's going on here. We define a key, something that appears to be its accessor and lastly a <code>(default)</code> section.
The comments here are helpful too, telling us what the supplied type is supposed to be.
</p>

<p>
We can see <code>%default-kernel-arguments</code> is being used here. We can check its value by evaluating it within the REPL.
</p>
<div class="org-src-container">
<pre class="src src-scheme">scheme@<span style="color: #61bfff;">(</span>guile-user<span style="color: #61bfff;">)</span>&gt; %default-kernel-arguments
$5 = <span style="color: #61bfff;">(</span><span style="color: #f1fa8c;">"modprobe.blacklist=usbmouse,usbkbd"</span> <span style="color: #f1fa8c;">"quiet"</span><span style="color: #61bfff;">)</span>
</pre>
</div>
<p>
So the <code>%default-kernel-arguments</code> is just a list of strings.
</p>

<p>
From this we can see that adding a custom kernel argument in the <code>config.scm</code> would be as simple as adding a string to this list like so: 
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span>operating-system
  ...

  <span style="color: #ff79c6;">(</span>kernel-arguments <span style="color: #50fa7b;">(</span>cons <span style="color: #f1fa8c;">"nomodeset"</span> %default-kernel-arguments<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  ...
  <span style="color: #61bfff;">)</span>
</pre>
</div>

<p>
I've already learned something cool about how Guix handles kernel arguments and the system declaration!
</p>
</div>
</div>

<div id="outline-container-orgf4f279c" class="outline-2">
<h2 id="orgf4f279c">Hacking continued - a look into the package values</h2>
<div class="outline-text-2" id="text-orgf4f279c">
<p>
With this basic knowledge I can look at some of the more interesting default values that are part of my configuration.
</p>

<p>
Let's start by peeking into the default package list, stored as <code>%base-packages</code>.
</p>
<div class="org-src-container">
<pre class="src src-scheme">scheme@<span style="color: #61bfff;">(</span>guile-user<span style="color: #61bfff;">)</span>&gt; %base-packages
$6 = <span style="color: #61bfff;">(</span>#&lt;package guix-icons@0.1 gnu/packages/package-management.scm:629 7f1836ad24d0&gt; #&lt;package less@608 gnu/packages/less.scm:38 7f183a855210&gt; #&lt;package mg@20221112 gnu/packages/text-editors.scm:502 7f1836bad370&gt; #&lt;package nano@7.2 gnu/packages/nano.scm:32 7f18313429a0&gt; #&lt;package nvi@1.81.6 gnu/packages/nvi.scm:32 7f183042bd10&gt; #&lt;package man-db@2.11.1 gnu/packages/man.scm:128 7f182f1f2d10&gt; #&lt;package info-reader@6.8 gnu/packages/texinfo.scm:195 7f182f720bb0&gt; #&lt;package bash-completion@2.11 gnu/packages/bash.scm:301 7f182f513370&gt; #&lt;package kbd@2.5.1 gnu/packages/linux.scm:3908 7f18311676e0&gt; #&lt;package sudo@1.9.13p2 gnu/packages/admin.scm:1958 7f182fc84d10&gt; #&lt;package guile-readline@3.0.9 gnu/packages/guile.scm:483 7f182f01c0b0&gt; #&lt;package guile-colorized@0.1 gnu/packages/guile-xyz.scm:1130 7f182f55fc60&gt; #&lt;package pciutils@3.8.0 gnu/packages/pciutils.scm:82 7f1836d19210&gt; #&lt;package usbutils@015 gnu/packages/linux.scm:2372 7f183114d420&gt; #&lt;package util-linux-with-udev@2.37.4 gnu/packages/linux.scm:2218 7f183114d790&gt; #&lt;package kmod@29 gnu/packages/linux.scm:4035 7f18311674d0&gt; #&lt;package eudev@3.2.11 gnu/packages/linux.scm:4145 7f1831167370&gt; #&lt;package inetutils@2.3 gnu/packages/admin.scm:893 7f182fc83b00&gt; #&lt;package isc-dhcp@4.4.3-P1 gnu/packages/admin.scm:1399 7f182fc83420&gt; #&lt;package iproute2@6.0.0 gnu/packages/linux.scm:3087 7f1831166630&gt; #&lt;package wget@1.21.3.24 gnu/packages/wget.scm:47 7f182f321f20&gt; #&lt;package iw@5.19 gnu/packages/linux.scm:3389 7f1831166160&gt; #&lt;package wireless-tools@30.pre9 gnu/packages/linux.scm:4507 7f1831181dc0&gt; #&lt;package procps@4.0.3 gnu/packages/linux.scm:2327 7f183114d4d0&gt; #&lt;package psmisc@23.5 gnu/packages/linux.scm:2044 7f183114d8f0&gt; #&lt;package which@2.21 gnu/packages/base.scm:1399 7f1830412000&gt; #&lt;package shadow@4.13 gnu/packages/admin.scm:950 7f182fc83a50&gt; #&lt;package e2fsprogs@1.46.4 gnu/packages/linux.scm:2446 7f183114d2c0&gt; #&lt;package guile@3.0.9 gnu/packages/guile.scm:317 7f182f01c2c0&gt; #&lt;package bash@5.1.16 gnu/packages/bash.scm:133 7f182f5136e0&gt; #&lt;package coreutils@9.1 gnu/packages/base.scm:365 7f182f1fd9a0&gt; #&lt;package findutils@4.9.0 gnu/packages/base.scm:327 7f182f1fda50&gt; #&lt;package grep@3.8 gnu/packages/base.scm:108 7f182f1fddc0&gt; #&lt;package sed@4.8 gnu/packages/base.scm:163 7f182f1fdd10&gt; #&lt;package diffutils@3.8 gnu/packages/base.scm:299 7f182f1fdb00&gt; #&lt;package patch@2.7.6 gnu/packages/base.scm:269 7f182f1fdbb0&gt; #&lt;package gawk@5.2.1 gnu/packages/gawk.scm:40 7f182f16b370&gt; #&lt;package tar@1.34 gnu/packages/base.scm:204 7f182f1fdc60&gt; #&lt;package gzip@1.12 gnu/packages/compression.scm:251 7f182f416630&gt; #&lt;package bzip2@1.0.8 gnu/packages/compression.scm:288 7f182f416580&gt; #&lt;package xz@5.2.8 gnu/packages/compression.scm:494 7f182f416370&gt; #&lt;package lzip@1.23 gnu/packages/compression.scm:625 7f182f4160b0&gt;<span style="color: #61bfff;">)</span>
</pre>
</div>

<p>
This output isn't particularly easy to parse, but it does tell us a few things. Probably the most important part is that packages are actually records too! This means we can also use a simple accessor to access different keys and their values.
</p>

<p>
I'm not entirely sure what the keys and their accessors are at this point, but I'll guess there's a <code>package-name</code> function. With this I can get a better look at the default package list.
</p>
<div class="org-src-container">
<pre class="src src-scheme">scheme@<span style="color: #61bfff;">(</span>guile-user<span style="color: #61bfff;">)</span>&gt; <span style="color: #61bfff;">(</span><span style="color: #ff79c6;">map</span> package-name %base-packages<span style="color: #61bfff;">)</span>
$7 = <span style="color: #61bfff;">(</span><span style="color: #f1fa8c;">"guix-icons"</span> <span style="color: #f1fa8c;">"less"</span> <span style="color: #f1fa8c;">"mg"</span> <span style="color: #f1fa8c;">"nano"</span> <span style="color: #f1fa8c;">"nvi"</span> <span style="color: #f1fa8c;">"man-db"</span> <span style="color: #f1fa8c;">"info-reader"</span> <span style="color: #f1fa8c;">"bash-completion"</span> <span style="color: #f1fa8c;">"kbd"</span> <span style="color: #f1fa8c;">"sudo"</span> <span style="color: #f1fa8c;">"guile-readline"</span> <span style="color: #f1fa8c;">"guile-colorized"</span> <span style="color: #f1fa8c;">"pciutils"</span> <span style="color: #f1fa8c;">"usbutils"</span> <span style="color: #f1fa8c;">"util-linux-with-udev"</span> <span style="color: #f1fa8c;">"kmod"</span> <span style="color: #f1fa8c;">"eudev"</span> <span style="color: #f1fa8c;">"inetutils"</span> <span style="color: #f1fa8c;">"isc-dhcp"</span> <span style="color: #f1fa8c;">"iproute2"</span> <span style="color: #f1fa8c;">"wget"</span> <span style="color: #f1fa8c;">"iw"</span> <span style="color: #f1fa8c;">"wireless-tools"</span> <span style="color: #f1fa8c;">"procps"</span> <span style="color: #f1fa8c;">"psmisc"</span> <span style="color: #f1fa8c;">"which"</span> <span style="color: #f1fa8c;">"shadow"</span> <span style="color: #f1fa8c;">"e2fsprogs"</span> <span style="color: #f1fa8c;">"guile"</span> <span style="color: #f1fa8c;">"bash"</span> <span style="color: #f1fa8c;">"coreutils"</span> <span style="color: #f1fa8c;">"findutils"</span> <span style="color: #f1fa8c;">"grep"</span> <span style="color: #f1fa8c;">"sed"</span> <span style="color: #f1fa8c;">"diffutils"</span> <span style="color: #f1fa8c;">"patch"</span> <span style="color: #f1fa8c;">"gawk"</span> <span style="color: #f1fa8c;">"tar"</span> <span style="color: #f1fa8c;">"gzip"</span> <span style="color: #f1fa8c;">"bzip2"</span> <span style="color: #f1fa8c;">"xz"</span> <span style="color: #f1fa8c;">"lzip"</span><span style="color: #61bfff;">)</span>
</pre>
</div>
<p>
Great, this is much more readable!
</p>

<p>
Seeing as <code>%base-packages</code> is actually just a list, I can also see how easy it is to manipulate it - let's remove <code>nano</code> from the default packages using a simple lambda filter.
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span>remove <span style="color: #ff79c6;">(</span><span style="color: #ff79c6;">lambda</span> <span style="color: #50fa7b;">(</span>pkg<span style="color: #50fa7b;">)</span> <span style="color: #50fa7b;">(</span>string= <span style="color: #bd93f9;">(</span>package-name pkg<span style="color: #bd93f9;">)</span> <span style="color: #f1fa8c;">"nano"</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span> %base-packages<span style="color: #61bfff;">)</span>
</pre>
</div>
<p>
This returns a brand new package list with <code>nano</code> missing this time. Pretty cool, I could definitely use this to strip out some unnecessary packages out of my system ;).
</p>

<p>
Basic list manipulation is actually very powerful within Guix. It's also going to allow me to modify the service list, among many other things - but more on that later.
</p>
</div>
</div>

<div id="outline-container-orgdce4635" class="outline-2">
<h2 id="orgdce4635">Package specification</h2>
<div class="outline-text-2" id="text-orgdce4635">
<p>
Looking into the <code>packages</code> section of my system configuration I notice the use of a specification function.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span>packages
 <span style="color: #ff79c6;">(</span>append
  <span style="color: #50fa7b;">(</span><span style="color: #ff79c6;">map</span> specification-&gt;package
       <span style="color: #bd93f9;">(</span>list
        <span style="color: #f1fa8c;">"nss-certs"</span>
        <span style="color: #f1fa8c;">"xf86-video-amdgpu"</span>
        <span style="color: #f1fa8c;">"amdgpu-firmware"</span>
        <span style="color: #f1fa8c;">"bluez"</span>
        <span style="color: #f1fa8c;">"blueman"</span>
        <span style="color: #f1fa8c;">"vim"</span>
        <span style="color: #f1fa8c;">"sway"</span>
        <span style="color: #f1fa8c;">"wofi"</span>
        <span style="color: #f1fa8c;">"libratbag"</span>
        <span style="color: #f1fa8c;">"git"</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
  %base-packages<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
</pre>
</div>

<p>
In essence it looks like <code>(specification-&gt;package)</code> takes a package name string and returns the first matching package definition it finds. I can verify this by looking at the definition of this function.
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span><span style="color: #ff79c6;">define</span> <span style="color: #ff79c6;">(</span><span style="color: #50fa7b;">specification-&gt;package</span> spec<span style="color: #ff79c6;">)</span>
  <span style="color: #f1fa8c;">"Return a package matching SPEC.  SPEC may be a package name, or a package</span>
<span style="color: #f1fa8c;">name followed by an at-sign and a version number.  If the version number is not</span>
<span style="color: #f1fa8c;">present, return the preferred newest version."</span>
  <span style="color: #ff79c6;">(</span><span style="color: #ff79c6;">let</span> <span style="color: #50fa7b;">(</span><span style="color: #bd93f9;">(</span>name version <span style="color: #0189cc;">(</span>package-name-&gt;name+version spec<span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
    <span style="color: #50fa7b;">(</span>%find-package spec name version<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
</pre>
</div>
<p>
I won't bother digging in deeper into the <code>%find-package</code> function now.
</p>
</div>
</div>

<div id="outline-container-org7714bdb" class="outline-2">
<h2 id="org7714bdb">Package record</h2>
<div class="outline-text-2" id="text-org7714bdb">
<p>
Let's look into the <code>package</code> record next. This one already looks very familiar to me, as I'm somewhat well versed in packaging for Guix by now.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span>define-record-type* <span style="color: #bd93f9;">&lt;package&gt;</span>
  package make-package
  package?
  this-package
  <span style="color: #ff79c6;">(</span>name   package-name<span style="color: #ff79c6;">)</span>                   <span style="color: #6272a4;">; </span><span style="color: #6272a4;">string</span>
  <span style="color: #ff79c6;">(</span>version package-version<span style="color: #ff79c6;">)</span>               <span style="color: #6272a4;">; </span><span style="color: #6272a4;">string</span>
  <span style="color: #ff79c6;">(</span>source package-source<span style="color: #ff79c6;">)</span>                 <span style="color: #6272a4;">; </span><span style="color: #6272a4;">&lt;origin&gt; instance</span>
  <span style="color: #ff79c6;">(</span>build-system package-build-system<span style="color: #ff79c6;">)</span>     <span style="color: #6272a4;">; </span><span style="color: #6272a4;">&lt;build-system&gt; instance</span>
  <span style="color: #ff79c6;">(</span>arguments package-arguments            <span style="color: #6272a4;">; </span><span style="color: #6272a4;">arguments for the build method</span>
             <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span> <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>inputs package-inputs                  <span style="color: #6272a4;">; </span><span style="color: #6272a4;">input packages or derivations</span>
          <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span> <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span>
          <span style="color: #50fa7b;">(</span>sanitize sanitize-inputs<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>propagated-inputs package-propagated-inputs    <span style="color: #6272a4;">; </span><span style="color: #6272a4;">same, but propagated</span>
                     <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span> <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span>
                     <span style="color: #50fa7b;">(</span>sanitize sanitize-inputs<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>native-inputs package-native-inputs    <span style="color: #6272a4;">; </span><span style="color: #6272a4;">native input packages/derivations</span>
                 <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span> <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span>
                 <span style="color: #50fa7b;">(</span>sanitize sanitize-inputs<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>outputs package-outputs                <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of strings</span>
           <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">(</span><span style="color: #f1fa8c;">"out"</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

                                                  <span style="color: #6272a4;">; </span><span style="color: #6272a4;">lists of</span>
                                                  <span style="color: #6272a4;">; </span><span style="color: #6272a4;">&lt;search-path-specification&gt;,</span>
                                                  <span style="color: #6272a4;">; </span><span style="color: #6272a4;">for native and cross</span>
                                                  <span style="color: #6272a4;">; </span><span style="color: #6272a4;">inputs</span>
  <span style="color: #ff79c6;">(</span>native-search-paths package-native-search-paths <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>search-paths package-search-paths <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #6272a4;">;; </span><span style="color: #6272a4;">The 'replacement' field is marked as "innate" because it never makes</span>
  <span style="color: #6272a4;">;; </span><span style="color: #6272a4;">sense to inherit a replacement as is.  See the 'package/inherit' macro.</span>
  <span style="color: #ff79c6;">(</span>replacement package-replacement                <span style="color: #6272a4;">; </span><span style="color: #6272a4;">package | #f</span>
               <span style="color: #50fa7b;">(</span>default #f<span style="color: #50fa7b;">)</span> <span style="color: #50fa7b;">(</span>thunked<span style="color: #50fa7b;">)</span> <span style="color: #50fa7b;">(</span>innate<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>synopsis package-synopsis
            <span style="color: #50fa7b;">(</span>sanitize validate-texinfo<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>          <span style="color: #6272a4;">; </span><span style="color: #6272a4;">one-line description</span>
  <span style="color: #ff79c6;">(</span>description package-description
               <span style="color: #50fa7b;">(</span>sanitize validate-texinfo<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>       <span style="color: #6272a4;">; </span><span style="color: #6272a4;">one or two paragraphs</span>
  <span style="color: #ff79c6;">(</span>license package-license                        <span style="color: #6272a4;">; </span><span style="color: #6272a4;">(list of) &lt;license&gt;</span>
           <span style="color: #50fa7b;">(</span>sanitize validate-license<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>home-page package-home-page<span style="color: #ff79c6;">)</span>                   <span style="color: #6272a4;">; </span><span style="color: #6272a4;">string</span>
  <span style="color: #ff79c6;">(</span>supported-systems package-supported-systems    <span style="color: #6272a4;">; </span><span style="color: #6272a4;">list of strings</span>
                     <span style="color: #50fa7b;">(</span>default %supported-systems<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>

  <span style="color: #ff79c6;">(</span>properties package-properties <span style="color: #50fa7b;">(</span>default '<span style="color: #bd93f9;">()</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>   <span style="color: #6272a4;">; </span><span style="color: #6272a4;">alist for anything else</span>

  <span style="color: #ff79c6;">(</span>location package-location-vector
            <span style="color: #50fa7b;">(</span>default <span style="color: #bd93f9;">(</span>current-location-vector<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
            <span style="color: #50fa7b;">(</span>innate<span style="color: #50fa7b;">)</span> <span style="color: #50fa7b;">(</span>sanitize sanitize-location<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span>
  <span style="color: #ff79c6;">(</span>definition-location package-definition-location-code
                       <span style="color: #50fa7b;">(</span>default <span style="color: #bd93f9;">(</span>current-definition-location<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
                       <span style="color: #50fa7b;">(</span>innate<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
</pre>
</div>
<p>
So packages really are just bog standard records!
</p>

<p>
So yet again we can use this knowledge to do some fancy stuff. Let's check the inputs of the <code>curl</code> package as an example. 
</p>
<div class="org-src-container">
<pre class="src src-scheme">scheme@<span style="color: #61bfff;">(</span>guile-user<span style="color: #61bfff;">)</span>&gt; ,use<span style="color: #61bfff;">(</span>gnu packages curl<span style="color: #61bfff;">)</span>

scheme@<span style="color: #61bfff;">(</span>guile-user<span style="color: #61bfff;">)</span>&gt; <span style="color: #61bfff;">(</span><span style="color: #ff79c6;">map</span> car <span style="color: #ff79c6;">(</span>package-inputs curl<span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
$14 = <span style="color: #61bfff;">(</span><span style="color: #f1fa8c;">"gnutls"</span> <span style="color: #f1fa8c;">"libidn"</span> <span style="color: #f1fa8c;">"mit-krb5"</span> <span style="color: #f1fa8c;">"nghttp2"</span> <span style="color: #f1fa8c;">"zlib"</span><span style="color: #61bfff;">)</span>
</pre>
</div>
<p>
Notice that I first had to import the correct module to get the <code>curl</code> definition. If you ever need to find which module contains a package, you can easily obtain this information using <code>guix show &lt;package&gt;</code>. 
</p>

<p>
Here's a fairly small package I wrote, you can see the practical usage of the record very clearly here.
You may be unfamiliar with a lot of these functions, but don't worry about that for now - just notice how the <code>package</code> record is used, that's the important part.
(also nevermind the ugly hacks, this is a package strictly for personal use&#x2026;).
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #61bfff;">(</span><span style="color: #ff79c6;">define-public</span> <span style="color: #50fa7b;">brogue-ce</span>
  <span style="color: #ff79c6;">(</span>package
   <span style="color: #50fa7b;">(</span>name <span style="color: #f1fa8c;">"brogue-ce"</span><span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>version <span style="color: #f1fa8c;">"1.12"</span><span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>source <span style="color: #bd93f9;">(</span>origin
            <span style="color: #0189cc;">(</span>method url-fetch<span style="color: #0189cc;">)</span>
            <span style="color: #0189cc;">(</span>uri <span style="color: #61bfff;">(</span>string-append <span style="color: #f1fa8c;">"https://github.com/tmewett/BrogueCE/archive/refs/tags/v"</span> version
                                <span style="color: #f1fa8c;">".tar.gz"</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span>
            <span style="color: #0189cc;">(</span>sha256
             <span style="color: #61bfff;">(</span>base32
              <span style="color: #f1fa8c;">"0a6l7j91iq0mv7zrxnlxx6ll5rfwvgfyk5h1gc9m5qzll1n3zvdf"</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>build-system gnu-build-system<span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>arguments
    <span style="color: #bd93f9;">(</span>list 
     <span style="color: #ffb86c;">#:make-flags</span> #~<span style="color: #0189cc;">(</span>list <span style="color: #f1fa8c;">"CC=gcc"</span><span style="color: #0189cc;">)</span>
     <span style="color: #ffb86c;">#:tests?</span> #f
     <span style="color: #ffb86c;">#:phases</span>
     #~<span style="color: #0189cc;">(</span>modify-phases %standard-phases
                      <span style="color: #61bfff;">(</span>delete 'configure<span style="color: #61bfff;">)</span>
                      <span style="color: #61bfff;">(</span>add-before 'build 'change-datadir-path
                                  <span style="color: #ff79c6;">(</span><span style="color: #ff79c6;">lambda</span> _
                                    <span style="color: #50fa7b;">(</span><span style="color: #ff79c6;">map</span>
                                     <span style="color: #bd93f9;">(</span><span style="color: #ff79c6;">lambda</span> <span style="color: #61bfff;">(</span>substitutes<span style="color: #61bfff;">)</span>
                                       <span style="color: #61bfff;">(</span>substitute* <span style="color: #f1fa8c;">"config.mk"</span>
                                                    <span style="color: #ff79c6;">(</span><span style="color: #50fa7b;">(</span><span style="color: #bd93f9;">(</span>car substitutes<span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
                                                     <span style="color: #50fa7b;">(</span>cdr substitutes<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #bd93f9;">)</span>
                                     `<span style="color: #bd93f9;">(</span><span style="color: #61bfff;">(</span><span style="color: #f1fa8c;">"^DATADIR := ."</span> . ,<span style="color: #ff79c6;">(</span>string-append <span style="color: #f1fa8c;">"DATADIR := "</span> #$output <span style="color: #f1fa8c;">"/share"</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
                                       <span style="color: #61bfff;">(</span><span style="color: #f1fa8c;">"^RELEASE := NO"</span> . <span style="color: #f1fa8c;">"RELEASE := YES"</span><span style="color: #61bfff;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
                      <span style="color: #61bfff;">(</span>replace 'install
                               <span style="color: #ff79c6;">(</span><span style="color: #ff79c6;">lambda</span> _
                                 <span style="color: #50fa7b;">(</span>mkdir-p <span style="color: #bd93f9;">(</span>string-append #$output <span style="color: #f1fa8c;">"/bin"</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
                                 <span style="color: #50fa7b;">(</span>copy-file <span style="color: #f1fa8c;">"bin/brogue"</span> <span style="color: #bd93f9;">(</span>string-append #$output <span style="color: #f1fa8c;">"/bin/.brogue_real"</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
                                 <span style="color: #50fa7b;">(</span><span style="color: #ff79c6;">call-with-output-file</span> <span style="color: #bd93f9;">(</span>string-append #$output <span style="color: #f1fa8c;">"/bin/brogue"</span><span style="color: #bd93f9;">)</span> <span style="color: #6272a4;">; </span><span style="color: #6272a4;">Wrap around executable and execute in ~/.local</span>
                                   <span style="color: #bd93f9;">(</span><span style="color: #ff79c6;">lambda</span> <span style="color: #61bfff;">(</span>file<span style="color: #61bfff;">)</span>
                                     <span style="color: #61bfff;">(</span>format file <span style="color: #f1fa8c;">"~A"</span> <span style="color: #ff79c6;">(</span>string-append
                                                        <span style="color: #f1fa8c;">"mkdir -p \"$HOME/.local/share/brogue\" &amp;&amp; cd \"$HOME/.local/share/brogue\" &amp;&amp; "</span>
                                                        #$output <span style="color: #f1fa8c;">"/bin/.brogue_real"</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
                                 <span style="color: #50fa7b;">(</span>invoke <span style="color: #f1fa8c;">"chmod"</span> <span style="color: #f1fa8c;">"+x"</span> <span style="color: #bd93f9;">(</span>string-append #$output <span style="color: #f1fa8c;">"/bin/brogue"</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
                                 <span style="color: #50fa7b;">(</span>copy-recursively <span style="color: #f1fa8c;">"bin/assets"</span> <span style="color: #bd93f9;">(</span>string-append #$output <span style="color: #f1fa8c;">"/share/assets"</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
                                 <span style="color: #50fa7b;">(</span>make-desktop-entry-file
                                  <span style="color: #bd93f9;">(</span>string-append  #$output <span style="color: #f1fa8c;">"/share/applications/brogue.desktop"</span><span style="color: #bd93f9;">)</span>
                                  <span style="color: #ffb86c;">#:name</span> <span style="color: #f1fa8c;">"Brogue"</span>
                                  <span style="color: #ffb86c;">#:exec</span> <span style="color: #f1fa8c;">"brogue"</span>
                                  <span style="color: #ffb86c;">#:categories</span> '<span style="color: #bd93f9;">(</span><span style="color: #f1fa8c;">"RolePlaying"</span> <span style="color: #f1fa8c;">"Game"</span><span style="color: #bd93f9;">)</span>
                                  <span style="color: #ffb86c;">#:keywords</span>
                                  '<span style="color: #bd93f9;">(</span><span style="color: #f1fa8c;">"adventure"</span> <span style="color: #f1fa8c;">"singleplayer"</span><span style="color: #bd93f9;">)</span>
                                  <span style="color: #ffb86c;">#:comment</span>
                                  '<span style="color: #bd93f9;">(</span><span style="color: #61bfff;">(</span>#f <span style="color: #f1fa8c;">"Brave the Dungeons of Doom!"</span><span style="color: #61bfff;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>inputs <span style="color: #bd93f9;">(</span>list <span style="color: #0189cc;">(</span>sdl-union <span style="color: #61bfff;">(</span>list sdl2 sdl2-image<span style="color: #61bfff;">)</span><span style="color: #0189cc;">)</span><span style="color: #bd93f9;">)</span><span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>synopsis <span style="color: #f1fa8c;">"Brogue CE: A dungeon crawler roguelike"</span><span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>description <span style="color: #f1fa8c;">"Community fork of Brogue"</span><span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>home-page <span style="color: #f1fa8c;">"https://github.com/tmewett/BrogueCE"</span><span style="color: #50fa7b;">)</span>
   <span style="color: #50fa7b;">(</span>license agpl3<span style="color: #50fa7b;">)</span><span style="color: #ff79c6;">)</span><span style="color: #61bfff;">)</span>
</pre>
</div>

<p>
I won't be digging deeper into the keys here now, but it's certainly very interesting to see how relatively simple and understandable the implementation is under the hood.
</p>
</div>
</div>

<div id="outline-container-orgf5cb206" class="outline-2">
<h2 id="orgf5cb206">End of part 1</h2>
<div class="outline-text-2" id="text-orgf5cb206">
<p>
There's still a lot left to explore, but I think we all need a break now.  Next time I'll look deeper into the <code>services</code> section, and I'll show some more practical applications of what we've learned so far.
</p>
</div>
</div>
